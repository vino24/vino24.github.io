<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        微信点歌模块代码更新及hexo音乐插件 | 逢十借一
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="vino24">
    <meta name="description" content="web前端开发, 前端开发工程师, 前端开发攻城师, 前端资源, CSS, JavaScript, HTML, Web标准">
    <meta name="keywords" content="web前端开发, 前端开发工程师, 前端开发攻城师, 前端资源, CSS, JavaScript, HTML, Web标准">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="逢十借一">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://vino24.cn">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="微信点歌模块代码更新及hexo音乐插件 | 逢十借一">
    <meta property="og:description" content="web前端开发, 前端开发工程师, 前端开发攻城师, 前端资源, CSS, JavaScript, HTML, Web标准">

     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

	<style>
		body{
            background-image: url(https://api.i-meto.com/bing?new);
        }
	</style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>

	<link rel="stylesheet" href="/css/highlight/solarized-white.css">

	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>

    <!-- Custom Head -->
    
</head>

	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                <!-- Post TOC -->

    
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-搜索模块重写"><span class="post-toc-number">1.</span> <span class="post-toc-text">[1] 搜索模块重写</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-hexo音乐插件"><span class="post-toc-number">2.</span> <span class="post-toc-text">[2] hexo音乐插件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-小结"><span class="post-toc-number">3.</span> <span class="post-toc-text">[3] 小结:</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-数据转换"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">[1] 数据转换</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-node中的同步请求"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">[2] node中的同步请求</span></a></li></ol></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>



<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		
			<!-- Random Thumbnail -->
			<div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
				<script>
    
    var randomNum;
    randomNum = Math.floor(Math.random() * 5 + 1);
    
    $(".post_thumbnail-random").css('background-image', 'url(' + '/img/random/' + randomNum + '.png' + ')');
    
</script>

		
	
        <p class="article-headline-p">
            微信点歌模块代码更新及hexo音乐插件
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>vino24</strong>
        <span>10月 31, 2016</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=微信点歌模块代码更新及hexo音乐插件&url=http://vino24.cn//2016/10/31/wechat-music-serach-module-update/index.html&via=vino24" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://vino24.cn//2016/10/31/wechat-music-serach-module-update/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=微信点歌模块代码更新及hexo音乐插件&url=http://vino24.cn//2016/10/31/wechat-music-serach-module-update/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<script src="/assets/js/APlayer.min.js"> </script><h3 id="1-搜索模块重写"><a href="#1-搜索模块重写" class="headerlink" title="[1] 搜索模块重写"></a>[1] 搜索模块重写</h3><p>由于云音乐那边接口的变动原本的音乐搜索功能没法使用了，于是就重写了一下。主要是关键词搜索的函数，其间发现其搜索的逻辑也发生了变化，所以相应的关键词分析匹配的地方也得重写。</p>
<p>核心的关键词搜索函数music_search<br><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment">// @param</span></div><div class="line"><span class="comment">// s:搜索关键词</span></div><div class="line"><span class="comment">// type: 类型(1:歌曲,100歌手)</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">music_search</span><span class="params">($s,$type=<span class="number">1</span>)</span></span></div><div class="line">&#123;</div><div class="line">    $type||$type=<span class="number">1</span>;</div><div class="line">    $url= <span class="string">"http://music.163.com/api/search/get/web?csrf_token="</span>;</div><div class="line">    $curl = curl_init();</div><div class="line">    $post_data = <span class="string">'hlpretag=&amp;hlposttag=&amp;s='</span>. $s . <span class="string">'&amp;type='</span>.$type.<span class="string">'&amp;offset=0&amp;total=true&amp;limit=1'</span>;</div><div class="line">    curl_setopt($curl, CURLOPT_URL,$url);</div><div class="line">    curl_setopt($curl, CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</div><div class="line">    $header =<span class="keyword">array</span>(</div><div class="line">        <span class="string">'Host: music.163.com'</span>,</div><div class="line">        <span class="string">'Origin: http://music.163.com'</span>,</div><div class="line">        <span class="string">'User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36'</span>,</div><div class="line">        <span class="string">'Content-Type: application/x-www-form-urlencoded'</span>,</div><div class="line">        <span class="string">'Referer: http://music.163.com/search/'</span>,</div><div class="line">    );</div><div class="line">    curl_setopt($curl, CURLOPT_HTTPHEADER, $header);</div><div class="line">    curl_setopt($curl, CURLOPT_POST, <span class="number">1</span>);</div><div class="line">    curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data);</div><div class="line">    $src = curl_exec($curl);</div><div class="line">    curl_close($curl);</div><div class="line">    <span class="keyword">return</span> $src;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取微信中需要数据函数getWechatFormatData(核心代码)<br><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWechatFormatData</span><span class="params">($word)</span></span></div><div class="line">&#123;</div><div class="line">    $result = json_decode(music_search($word), <span class="keyword">true</span>); <span class="comment">// 默认按歌曲先搜索一次（true转换为数组）</span></div><div class="line"></div><div class="line">    $is_Song = <span class="keyword">false</span>;   <span class="comment">// 搜索关键词是否为歌曲</span></div><div class="line">    $isEnglish = preg_match(<span class="string">"/^[a-zA-Z\s]+$/"</span>,$word);   <span class="comment">// 是否为英文歌/歌手</span></div><div class="line">    $arr = preg_split(<span class="string">"/[\s,]+/"</span>, $word);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(!$isEnglish) &#123;</div><div class="line">        <span class="keyword">if</span>(count($arr) == <span class="number">1</span>) &#123; <span class="comment">// 非英文且只有一个搜索关键词</span></div><div class="line">        $is_Song = $result[<span class="string">'result'</span>][<span class="string">'songs'</span>][<span class="number">0</span>][<span class="string">'name'</span>] == $word; <span class="comment">// 如果返回的歌曲名与搜索关键词相同即表示关键词为歌曲</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 非英文且多个关键词</span></div><div class="line">        <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; $keyword) &#123;</div><div class="line">            $result = json_decode(music_search($keyword) ,<span class="keyword">true</span>);</div><div class="line">            <span class="keyword">if</span>($result[<span class="string">'result'</span>][<span class="string">'songs'</span>][<span class="number">0</span>][<span class="string">'name'</span>] == $keyword) &#123;</div><div class="line">                $is_Song = <span class="keyword">true</span>;    <span class="comment">//  如果搜索结果中的歌曲名与关键词中的某字段匹配则该字段为歌曲名</span></div><div class="line">                $result = json_decode(music_search($arr[$key]) , <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//  全英文</span></div><div class="line">        $is_Song = stristr($word,$result[<span class="string">'result'</span>][<span class="string">'songs'</span>][<span class="number">0</span>][<span class="string">'name'</span>]); <span class="comment">// 如果搜索结果中的歌曲名中有某个字段则按歌曲搜索，否则按歌手搜索</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ($is_Song) &#123;</div><div class="line">        <span class="comment">// do operation</span></div><div class="line">        <span class="keyword">return</span> $info;</div><div class="line">    &#125;</div><div class="line">     <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// do operation</span></div><div class="line">        <span class="keyword">return</span> $info;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-hexo音乐插件"><a href="#2-hexo音乐插件" class="headerlink" title="[2] hexo音乐插件"></a>[2] hexo音乐插件</h3><p>前两天在微博上看到胡子歌在barretlee.com上做了一个歌单展示页，上面竟然李志，不行我也得整一个。看他说UI是用了一款开源的播放器<a href="https://github.com/DIYgod/APlayer" target="_blank" rel="external">APlayer</a>,于是简单看了下，巧的是已经有人写过一个基于APlayer的hexo插件 - <a href="https://github.com/grzhan/hexo-tag-aplayer" target="_blank" rel="external">hexo-tag-aplayer</a>。不过看了只能添加单曲，添加不了专辑或是歌单。正好刚重写了搜索的API，感觉可以搞一搞。</p>
<p>插件用的是利用了Hexo可以自定义标签插件自定义了歌单标签。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">hexo.extend.tag.register(<span class="string">'aplayerlist'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> albumlist_id = args[<span class="number">0</span>], narrow = <span class="literal">false</span>, autoplay = <span class="literal">false</span>, width = <span class="string">''</span>,</div><div class="line">        id = <span class="string">'aplayer'</span> + (counter++), raw = <span class="string">''</span>, content = <span class="string">''</span>;</div><div class="line">    <span class="comment">// Parse optional arguments</span></div><div class="line">    <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">var</span> options = args.slice(<span class="number">1</span>);</div><div class="line">        narrow = options.indexOf(<span class="string">'narrow'</span>) &lt; <span class="number">0</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</div><div class="line">        autoplay = options.indexOf(<span class="string">'autoplay'</span>) &lt; <span class="number">0</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; options.length; i++) &#123;</div><div class="line">            <span class="keyword">var</span> option = options[i];</div><div class="line">            width = option.indexOf(<span class="string">'width:'</span>) == <span class="number">0</span> ? option + <span class="string">';'</span> : width;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    width = narrow ? <span class="string">''</span> : width;</div><div class="line">    <span class="keyword">var</span> album;</div><div class="line">    <span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">        req.open(<span class="string">'GET'</span>, <span class="string">"***/hexo_playlist.php?id="</span> + albumlist_id, <span class="literal">false</span>);</div><div class="line">        req.send();</div><div class="line">        <span class="keyword">if</span>(req.status === <span class="number">200</span>) &#123;</div><div class="line">            album = req.responseText;</div><div class="line">        &#125;</div><div class="line">        raw = <span class="string">'&lt;div id="'</span>+ id + <span class="string">'" class="aplayer" style="margin-bottom: 20px;display:inline-block;'</span>+ width + <span class="string">'"&gt;'</span>;</div><div class="line">        raw +=</div><div class="line">        <span class="string">'&lt;/div&gt;&lt;script&gt;var '</span>+ id + <span class="string">' = new APlayer(&#123;'</span>+</div><div class="line">                <span class="string">'element: document.getElementById("'</span>+ id +<span class="string">'"),'</span> +</div><div class="line">                <span class="string">'narrow: '</span> + (narrow ? <span class="string">'true'</span> : <span class="string">'false'</span>) + <span class="string">','</span> +</div><div class="line">                <span class="string">'autoplay: '</span> + (autoplay ? <span class="string">'true'</span> : <span class="string">'false'</span>) + <span class="string">','</span> +</div><div class="line">                <span class="string">'music : '</span> + album +</div><div class="line">            <span class="string">'&#125;);'</span> +</div><div class="line">        id + <span class="string">'.init();&lt;/script&gt;'</span>;</div><div class="line">    <span class="keyword">return</span> raw;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>然后在md文件中以<code><div id="aplayer0" class="aplayer" style="margin-bottom: 20px;display:inline-block;"></div><script>var aplayer0 = new APlayer({element: document.getElementById("aplayer0"),narrow: false,autoplay: false,music : 
Notice: Undefined index: album in /data/home/qxu1098560294/htdocs/wechat/hexo_api.php on line 66

Warning: Invalid argument supplied for foreach() in /data/home/qxu1098560294/htdocs/wechat/hexo_api.php on line 68
[]});aplayer0.init();</script></code>的格式即可调用。<br>其中只有<code>album_id</code>这个参数是必须的，传入的是专辑的id，当然也可以传歌单id，只要在实现里面调歌单搜索的API即可。后面的参数都是可选的。</p>
<ul>
<li><code>narrow</code>是否显示歌曲列表，默认隐藏</li>
<li><code>autoplay</code> 是否自动播放<br>除此之外还可以配置大小，不过这个地方我直接设了固定的宽度。</li>
</ul>
<p>插件原本一个标签只能放一首歌，于是也重写了下<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">&#123;% aplayer [&#123;&#125;,&#123;&#125;]  [narrow, autoplay] %&#125;</div></pre></td></tr></table></figure></p>
<p>以数组的形式传入包含每首歌的信息的对象即可，代码如下:<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">hexo.extend.tag.register(<span class="string">'aplayer'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> narrow = <span class="literal">false</span>, autoplay = <span class="literal">false</span>, width = <span class="string">''</span>,</div><div class="line">        id = <span class="string">'aplayer'</span> + (counter++), raw = <span class="string">''</span>, content = <span class="string">''</span>;</div><div class="line">    <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">var</span> options = args.slice(<span class="number">1</span>);</div><div class="line">        narrow = options.indexOf(<span class="string">'narrow'</span>) &lt; <span class="number">0</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</div><div class="line">        autoplay = options.indexOf(<span class="string">'autoplay'</span>) &lt; <span class="number">0</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; options.length; i++) &#123;</div><div class="line">            <span class="keyword">var</span> option = options[i];</div><div class="line">            width = option.indexOf(<span class="string">'width:'</span>) == <span class="number">0</span> ? option + <span class="string">';'</span> : width;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    width = narrow ? <span class="string">''</span> : width;</div><div class="line">    <span class="keyword">var</span> album = [];</div><div class="line">    <span class="keyword">var</span> data = <span class="built_in">eval</span>(args[<span class="number">0</span>]);</div><div class="line">    data.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">song</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> song_info = &#123;</div><div class="line">            <span class="attr">title</span>: song[<span class="number">0</span>],</div><div class="line">            <span class="attr">author</span>: song[<span class="number">1</span>],</div><div class="line">            <span class="attr">url</span>: song[<span class="number">2</span>],</div><div class="line">            <span class="attr">pic</span>: song[<span class="number">3</span>]</div><div class="line">        &#125;;</div><div class="line">    album.push(song_info);</div><div class="line">    &#125;);</div><div class="line">    raw = <span class="string">'&lt;div id="'</span>+ id + <span class="string">'" class="aplayer" style="margin-bottom: 20px;'</span>+ width + <span class="string">'"&gt;'</span>;</div><div class="line">    raw +=</div><div class="line">        <span class="string">'&lt;/div&gt;&lt;script&gt;var '</span>+ id + <span class="string">' = new APlayer(&#123;'</span>+</div><div class="line">                <span class="string">'element: document.getElementById("'</span>+ id +<span class="string">'"),'</span> +</div><div class="line">                <span class="string">'narrow: '</span> + (narrow ? <span class="string">'true'</span> : <span class="string">'false'</span>) + <span class="string">','</span> +</div><div class="line">                <span class="string">'autoplay: '</span> + (autoplay ? <span class="string">'true'</span> : <span class="string">'false'</span>) + <span class="string">','</span> +</div><div class="line">                <span class="string">'music : '</span> + <span class="built_in">JSON</span>.stringify(album) +</div><div class="line">            <span class="string">'&#125;);'</span> +</div><div class="line">        id + <span class="string">'.init();&lt;/script&gt;'</span>;</div><div class="line">    <span class="keyword">return</span> raw;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="3-小结"><a href="#3-小结" class="headerlink" title="[3] 小结:"></a>[3] 小结:</h3><p>插件本身没什么技术含量，利用了之前写好的搜索接口，获取到数据后按照APlayer的格式生成APlayer对象即可。但还是出现了两个很蛋疼的事情：一个是从接口获取到数据后的转换，一个是node中的同步ajax。</p>
<h4 id="1-数据转换"><a href="#1-数据转换" class="headerlink" title="[1] 数据转换"></a>[1] 数据转换</h4><p>APlayer音乐信息部分的数据是这样的<code>[{title:, url:,xxx:...},{title:, url:,xxx:...}]</code>。但是php如果直接传数组过来根本没法用，因为php中的数组是这样的格式:<br><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="keyword">array</span>(</div><div class="line">    [<span class="number">0</span>] =&gt; &#123;&#125;,</div><div class="line">    [<span class="number">1</span>] =&gt; &#123;&#125;</div><div class="line">    )</div></pre></td></tr></table></figure></p>
<p>这样的传过来根本没法解析(应该是解析起来麻烦)。json格式也试了，序列化的时候还是带php数组的那一坨。思来想去还是字符串靠谱，虽然拼字符串很烦，仿佛又回到了后端模板的时代，不过确实很管用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">batch_get_song_info</span><span class="params">($album_id)</span></span></div><div class="line">&#123;</div><div class="line">    $result = json_decode(get_album_info($album_id), <span class="keyword">true</span>);</div><div class="line">    $result = $result[<span class="string">"album"</span>][<span class="string">"songs"</span>];</div><div class="line">    $song_list = <span class="string">"["</span>;</div><div class="line">    <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $key =&gt; $song) &#123;</div><div class="line">        $result = json_decode(get_music_info($song[<span class="string">'id'</span>]), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        $result = $result[<span class="string">'songs'</span>][<span class="number">0</span>];</div><div class="line">        $info = <span class="string">"&#123;"</span>;</div><div class="line">        $music_name = $result[<span class="string">'name'</span>];</div><div class="line">        $artist_name = $result[<span class="string">'artists'</span>][<span class="number">0</span>][<span class="string">'name'</span>];</div><div class="line">        $music_url = $result[<span class="string">'mp3Url'</span>];</div><div class="line">        $music_pic = $result[<span class="string">'album'</span>][<span class="string">'picUrl'</span>];</div><div class="line">        $info .= <span class="string">"title:'"</span> .$music_name . <span class="string">"',author:'"</span> . $artist_name . <span class="string">"',url:'"</span> .$music_url . <span class="string">"',pic:'"</span> . $music_pic . <span class="string">"'&#125;,"</span>;</div><div class="line">        $song_list .= $info;</div><div class="line">    &#125;</div><div class="line">     $song_list = rtrim($song_list,<span class="string">","</span>);</div><div class="line">     $song_list .= <span class="string">"]"</span>;</div><div class="line">     <span class="keyword">return</span> $song_list;</div><div class="line">&#125;</div><div class="line"><span class="comment">// example</span></div><div class="line">$album_id = $_GET[<span class="string">'id'</span>];</div><div class="line">$result = get_album_detail($album_id);</div><div class="line">print_r($result);</div></pre></td></tr></table></figure>
<p>出入专辑id之后get_album_info获取专辑内所有歌曲的id(不得不佩服老东家，云音乐的大部分API都无法一次得到你想要的所有数据,当时MV和歌单那块还是我写的呢，唉…)，然后用get_music_info挨个搜一遍，最后就是蛋疼的拼字符串。</p>
<h4 id="2-node中的同步请求"><a href="#2-node中的同步请求" class="headerlink" title="[2] node中的同步请求"></a>[2] node中的同步请求</h4><p>一开始想用高大上的fetch，但是fetch好像没法同步请求，试了一大推其他的模块，最后还是回到了我熟悉的xhr<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// xmlhttprequest node中的XHR模块</span></div><div class="line">    XMLHttpRequest = <span class="built_in">require</span>(<span class="string">"xmlhttprequest"</span>).XMLHttpRequest;</div><div class="line">    <span class="keyword">var</span> album, req = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">        req.open(<span class="string">'GET'</span>, <span class="string">"http://bgm.iminyao.com/wechat/hexo_playlist.php?id="</span> + albumlist_id, <span class="literal">false</span>);</div><div class="line">        req.send();</div><div class="line">        <span class="keyword">if</span>(req.status === <span class="number">200</span>) &#123;</div><div class="line">            album = req.responseText;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>熟悉的感觉，还是原来味道。</p>
<p>这还不是关键，关键是发现自己对请求这块还不是很熟悉，包括XMLHttpRequest，更别说fetch了，特别是数据类型这一块，回头得好好总结一下。</p>
<p>还有一个大彩蛋，写完了往博客上添专辑的时候才想起来，虾米垄断了滚石的版权，小李的音乐包括《理性与感性作品音乐会》基本上都跪了。最蛋疼的是通过API还能搜到音乐资源，但是资源已经失效…专辑搜索的接口就是这么玩的，数据里面有MP3链接，但是全部是404…这个问题待解决。</p>
<p>有钱真好，马云爸爸，请收下我的膝盖😭</p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
                    
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #0097A7 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #0097A7 !important;
    }
    #ds-reset .ds-highlight {
        color: #0097A7 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
        <div class="ds-thread" 
            data-thread-key="2016/10/31/wechat-music-serach-module-update/" 
            data-url="http://vino24.cn/2016/10/31/wechat-music-serach-module-update/"
            data-title="微信点歌模块代码更新及hexo音乐插件"></div>
    <!-- 多说评论框 end -->
</div>



                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2016/11/01/hexo-basic/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/10/27/three.js-first/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="vino24's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jzwmxz@hotmail.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="jzwmxz@hotmail.com" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="/about" title="about">
				about
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             文章总数
             <span class="sidebar-badge">106</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/vino24/" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;逢十借一</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>








    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"vino24"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->




<!-- Swiftye -->


<!-- Local Search-->

	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
        var inputArea = document.querySelector("#search");
        var getSearchFile = function(){
            var path = "search.xml";
            searchFunc(path, 'search', 'local-search-result');
        }

        inputArea.onfocus = function(){ getSearchFile() }
	</script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>

<!-- MathJax Load-->

            </main>
        </div>
		
    </body>
		
	
</html>
